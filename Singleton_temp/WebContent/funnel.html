<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<link rel="stylesheet" type="text/css" href="css/easyui.css">
	<link rel="stylesheet" type="text/css" href="css/icon.css">
	<link rel="stylesheet" type="text/css" href="css/demo.css">
	
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="echarts/echarts.js"></script>
	<script type="text/javascript" src="echarts/funnelchart.js"></script>
	<script type="text/javascript" src="js/funnel.js"></script>
<title>funnelchart</title>
</head>
<body>
	<!--布局div-->
	<div class="easyui-layout" data-options="border:false,fit:true" style="width:100%;height:100%">
		<div data-options="region:'west'" style="width:40%;height:100%">
			<!-- 嵌套布局div -->
			<div class="easyui-layout" style="width:100%;height:100%;">
				<!--左上选择指标维度div-->
				<div data-options="region:'north'" style="width:80%;height:40%;padding:20px">
					数据选择：
					<div id="funnel_div_kpi" style="width:80%;height:15%;padding:20px">
						<select id="funnel_sel_charttype" name="funnel_sel_rate" class="easyui-combobox" style="width:100px"></select>
						Kpi：
						<button id="funnel_button_kpi" class="easyui-linkbutton" onclick="$('#window_kpi').window('open')">选择KPI</button>
						<!--button id="ccc" class="easyui-linkbutton">check</button-->
					</div>
					<!-- 时间维度div -->
					<div id="funnel_div_dim1" style="width:80%;height:15%;padding:20px">
						频率：
						<select id="funnel_sel_rate" name="funnel_sel_rate" class="easyui-combobox" style="width:70px"></select>
						时间：
						<input id="funnel_sel_time_date" name="funnel_sel_time_date" class="easyui-datebox" style="width:110px" />
						<select id="funnel_sel_time_ym" name="funnel_sel_time_ym" class="easyui-combobox" style="width:100px"></select>
					</div>
					<!-- 科室维度div -->
					<div id="funnel_div_dim2" style="width:80%;height:15%;padding:20px">
						部门：
						<select id="funnel_sel_area" name="funnel_sel_area" class="easyui-combotree" style="width:150px;"></select>
					</div>
				</div>
				<!-- 左中选择变量生成饼状图div -->
				<div data-options="region:'center'" style="width:50%;height:30% ;padding:20px">
					<div id="funnel_div_chart_dims" style="width:50%;height:15% ;padding:20px">
						<p id="funnel_p_var">选择占比的维度</p>
						<select id="funnel_sel_dim_chart" name="funnel_sel_time_ym" class="easyui-combobox" style="width:100px"></select>
					</div>
					<div id="funnel_div_chart_dim1" style="height:15% ;padding:20px">
						起始时间：
						<div id="funnel_div_ym">
							<select id="funnel_sel_time_ym_f" name="funnel_sel_time_ym_f" class="easyui-combobox" style="width:100px"></select>
						</div>
						<div id="funnel_div_date">
							<input id="funnel_sel_time_date_f" name="funnel_sel_time_date_f" class="easyui-datebox" style="width:110px" />
						</div>
					</div>
					<div id="funnel_div_chart_dim2">
					</div>
					<div style="height:15% ;padding:20px">
						<button id="button_makechart" class="easyui-linkbutton">生成图形</button>
					</div>
				</div>
				<!-- 左下图形参数设置div -->
				<div data-options="region:'south'" style="width:50%;height:30%;padding:20px">
					图形参数选择：
					<div id="funnel_div_3">
						<div id="funnel_div_var" style="padding:20px">
							<p id="funnel_p_title">饼状图标题：</p>
							<input id="funnel_text_title" class="easyui-textbox" data-options="prompt:'输入标题'" style="width:50%;height:32px" />
						</div>
						<!-- 玫瑰图的div -->
						<div id="funnel_div_isrose" style="width:50%;height:15%;padding:20px">
							是否为玫瑰图：
							<input type="radio" name="isrose" value="false" />否
							<input type="radio" name="isrose" value="true"/>是
						</div>
						<!-- 半径的div -->
						<div id="funnel_div_radius1" style="width:100%;height:15%;padding:20px">
							选择内半径：
							<select id="funnel_sel_inner_radius" name="funnel_sel_inner_radius" class="easyui-combobox" style="width:70px"></select>
							选择外半径：
							<select id="funnel_sel_outer_radius" name="funnel_sel_outer_radius" class="easyui-combobox" style="width:70px"></select>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 右边显示饼状图div -->
		<div id="funnel_div_chart" data-options="region:'center'" style="width:60%;height:100%;padding:0px">
			
		</div>
	</div>
			<!-- 选择kpi窗口 -->
			<div id="window_kpi" class="easyui-window">
				<div class="easyui-layout" data-options="fit:true">
					<div data-options="region:'center',border:false" style="padding:10px;">
						<div id="tab_kpi" class="easyui-tabs" data-options="fit:true">
							<div title="全部" style="padding:10px">
								<ul id="tree_kpi" class="easyui-tree"></ul>
							</div>
							<div title="搜索" style="padding:10px">
								<table id="db_kpi"class="easyui-datagrid" style="width:700px;height:99%" data-options="border:false,fit:true,rownumbers:true,singleSelect:true,method:'get',toolbar:'#search_kpi'">
									<thead>
										<tr>
											<th data-options="field:'value',width:80,hidden:true">ID</th>
											<th data-options="field:'text',width:180">名称</th>
										</tr>
									</thead>
								</table>
							</div>
						</div>
					</div>
					<div data-options="region:'south',border:false" style="text-align:right;padding:5px 0 0;">
						<a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" href="javascript:void(0)" onclick="choose()" style="width:80px">选择</a>
						<a class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" href="javascript:void(0)" onclick="$('#window_kpi').window('close')" style="width:80px">关闭</a>
					</div>
				</div>
			</div>
			<div id="search_kpi" style="padding:2px 5px;">
				<input class="easyui-searchbox" data-options="prompt:'请输入要查找的指标',searcher:doSearch,fit:true" style="width:200px"></input>
			</div>
	<script type="text/javascript">
		function doSearch(value) {
			$.ajax({
				url : "SearchKpiServlet?variable="+value,
				dataType : "json",
				success : function(data) {
					$('#db_kpi').datagrid('loadData', data);
				},
				error : function() {
					alert("查不到输入的指标");
				}
			})
		}
		
		var kpi_id = "";
		
		function choose(){
			//alert($('.tabs-selected').text());
			if ($('.tabs-selected').text() == "全部") {
				//alert($('#tree_kpi').tree('getSelected').id);
				kpi_id = $('#tree_kpi').tree('getSelected').id;
				var kpi_text =$('#tree_kpi').tree('getSelected').text;
				$('#funnel_div_chart_dims').show();
				$.ajax({
					url : "ajax/GetDimValue.txt",
					dataType : "text",
					success : function(data) {
						var temp = data.split('@');
						data = temp[0];
						var dims = data.split(",");
						for(var i=0; i<dims.length; i++){
							//说明该指标包含时间维度
							if(dims[i] == "1"){
								$('#funnel_div_dim1').show();
							}
							else if(dims[i] == "2"){
								$('#funnel_div_dim2').show();
							}
						}
						$('#funnel_button_kpi').html(kpi_text);
					},
					error : function(){
						alert("111");
					}
				})
				$.ajax({
					url : "ajax/GetDimValue.txt",
					dataType : "text",
					success : function(data1) {
						var temp = data1.split('@');
						data1 = temp[1];
						data = JSON.parse(data1); 
						$('#funnel_sel_dim_chart').combobox('loadData', data);
						//有时间变量
						if($('#funnel_sel_dim_chart').combobox('getValue') == "1"){
							$('#funnel_div_chart_dim1').show();
							if($('#funnel_sel_rate').combobox('getValue') != "date"){
								$('#funnel_div_ym').show();
								$('#funnel_div_date').hide();
							}else{
								$('#funnel_div_date').show();
								$('#funnel_div_ym').hide();
							}
						}
					},
					error : function(){
						alert("222");
					}
				})
			} else {
				//alert($('#db_kpi').datagrid('getSelected').value);
				kpi_id = $('#db_kpi').datagrid('getSelected').value;
				var kpi_text=$('#db_kpi').datagrid('getSelected').text;
				$('#funnel_div_chart_dims').show();
				$.ajax({
					url : "ajax/GetDimValue.txt",
					dataType : "text",
					success : function(data) {
						var temp = data.split('@');
						data = temp[0];
						var dims = data.split(",");
						for(var i=0; i<dims.length; i++){
							//说明该指标包含时间维度
							if(dims[i] == "1"){
								$('#funnel_div_dim1').show();
							}
							else if(dims[i] == "2"){
								$('#funnel_div_dim2').show();
							}
						}
						$('#funnel_button_kpi').html(kpi_text);
					},
					error : function(){
						alert("333");
					}
				})
				$.ajax({
					url : "ajax/GetDimValue.txt",
					dataType : "text",
					success : function(data1) {
						var temp = data1.split('@');
						data1 = temp[1];
						data = JSON.parse(data1); 
						$('#funnel_sel_dim_chart').combobox('loadData', data);
						//有时间变量
						if($('#funnel_sel_dim_chart').combobox('getValue') == "1"){
							$('#funnel_div_chart_dim1').show();
							if($('#funnel_sel_rate').combobox('getValue') != "date"){
								$('#funnel_div_ym').show();
								$('#funnel_div_date').hide();
							}else{
								$('#funnel_div_date').show();
								$('#funnel_div_ym').hide();
							}
						}
					},
					error : function(){
						alert("444");
					}
				})
			}
			//$('#funnel_div_var').show();
			//$('#funnel_div_isrose').show();
			//$('#funnel_div_radius').show();
			$('#window_kpi').window('close');
		}
	</script>
</body>
</html>