<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Saving Portal State - jQuery EasyUI</title>
    <link rel="stylesheet" type="text/css" href="css/easyui.css">
	<link rel="stylesheet" type="text/css" href="css/icon.css">
    
    <script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="echarts/echarts.js"></script>
    <script type="text/javascript" src="js/portal.js"></script>
</head>
<body id="portal_edit_1_body" style="margin:0px;">
	<div>
		报表展示类型：<select id="portal_edit_1_type" class="easyui-combobox" style="width: 80px"></select>
	</div>
    <div id="portal_edit_1_div"></div>
    
<script type="text/javascript">
    var panels = [
        {id:'p1',title:'饼状图',collapsible:true,closable:true,href:'portal_p1.html'},
        {id:'p2',title:'柱状图',collapsible:true,closable:true,href:'portal_p2.html'},
        {id:'p3',title:'面积图',collapsible:true,closable:true,href:'portal_p3.html'},
        {id:'p4',title:'散点图',collapsible:true,closable:true,href:'portal_p4.html'},
        {id:'p5',title:'漏斗图',collapsible:true,closable:true,href:'portal_p5.html'},
        {id:'p6',title:'雷达图',collapsible:true,closable:true,href:'portal_p6.html'}
    ];
    
    var options_type = [{value : "1",text : "2xn"},{value : "2",text : "3xn"}];
    
    function getCookie(name){
        var cookies = document.cookie.split(';');
        if (!cookies.length) return '';
        for(var i=0; i<cookies.length; i++){
            var pair = cookies[i].split('=');
            if ($.trim(pair[0]) == name){
                return $.trim(pair[1]);
            }
        }
        return '';
    }
    function getPanelOptions(id){
        for(var i=0; i<panels.length; i++){
            if (panels[i].id == id){
                return panels[i];
            }
        }
        return undefined;
    }
    function getPortalState(){
        var aa = [];
        for(var columnIndex=0; columnIndex<3; columnIndex++){
            var cc = [];
            var panels = $('#portal_edit_1_div').portal('getPanels', columnIndex);
            for(var i=0; i<panels.length; i++){
                cc.push(panels[i].attr('id'));
            }
            aa.push(cc.join(','));
        }
        return aa.join(':');
    }
    //按当前的portal顺序加载portal
    function addPanels(portalState){
    	//分隔每列的portal
        var columns = portalState.split(':');
        for(var columnIndex=0; columnIndex<columns.length; columnIndex++){
        	//分隔每列每一行的portal
            var cc = columns[columnIndex].split(',');
            for(var j=0; j<cc.length; j++){
                var options = getPanelOptions(cc[j]);
                if (options){
                    var p = $('<div/>').attr('id',options.id).appendTo('body');
                    p.panel(options);
                    $('#portal_edit_1_div').portal('add',{
                        panel:p,
                        columnIndex:columnIndex
                    });
                }
            }
        }
        
    }
    
    $(function(){
    	$('#portal_edit_1_type').combobox({
    		valueField : 'value',
    		textField : 'text',
    		panelHeight : 'auto',
    		data : options_type,
    		
    		onLoadSuccess : function() {
    			var data = $('#portal_edit_1_type').combobox('getData');
    			$('#portal_edit_1_type').combobox('select', data[0].value);
    		},
    		
    		onChange : function(){
				$('#portal_edit_1_div').empty();
    			//拿到用户选择的数据列表类型
    			var selValue = $('#portal_edit_1_type').combobox('getValue');
    			if(selValue == "1"){//用户选择了2xn类型
    				//控制portal中加入两列
    				$('#portal_edit_1_div').append('<div id="portal_edit_1_left_div" ></div>');
    				$('#portal_edit_1_div').append('<div id="portal_edit_1_right_div" ></div>');
    				//控制所有div的宽度
    				$('#portal_edit_1_div').width($('#portal_edit_1_body').width());
    	        	$('#portal_edit_1_left_div').width($('#portal_edit_1_div').width()/2);
    	        	$('#portal_edit_1_right_div').width($('#portal_edit_1_div').width()/2);
    	        	//重新加载一次报表
    	        	$('#portal_edit_1_div').portal({
    	                onStateChange:function(){
    	                    var state = getPortalState();
    	                    var date = new Date();
    	                    date.setTime(date.getTime() + 24*3600*1000);
    	                    document.cookie = 'portal-1-state='+state+';expires='+date.toGMTString();
    	                }
    	            });
    	            var state = getCookie('portal-1-state');
    	            if (!state){
    	                state = 'p1,p2,p3:p4,p5,p6';    // the default portal state
    	            }
    	            addPanels(state);
    	            $('#portal_edit_1_div').portal('resize');
    	        	
    			} else if(selValue == "2"){//用户选择了3xn类型
    				//控制portal中加入三列
    				$('#portal_edit_1_div').append('<div id="portal_edit_1_left_div" ></div>');
    				$('#portal_edit_1_div').append('<div id="portal_edit_1_center_div" ></div>');
    				$('#portal_edit_1_div').append('<div id="portal_edit_1_right_div" ></div>');
    				//控制所有div的宽度
    				$('#portal_edit_1_div').width($('#portal_edit_1_body').width());
    	        	$('#portal_edit_1_left_div').width($('#portal_edit_1_div').width()/3);
    	        	$('#portal_edit_1_center_div').width($('#portal_edit_1_div').width()/3);
    	        	$('#portal_edit_1_right_div').width($('#portal_edit_1_div').width()/3);
    	        	
    	        	//重新加载一次报表
    	        	$('#portal_edit_1_div').portal({
    	                onStateChange:function(){
    	                    var state = getPortalState();
    	                    var date = new Date();
    	                    date.setTime(date.getTime() + 24*3600*1000);
    	                    document.cookie = 'portal-1-state='+state+';expires='+date.toGMTString();
    	                }
    	            });
    	            var state = getCookie('portal-1-state');
    	            if (!state){
    	                state = 'p1,p2:p3,p4:p5,p6';    // the default portal state
    	            }
    	            addPanels(state);
    	            $('#portal_edit_1_div').portal('resize');
    			}
    		}
    	})
    });
</script>
</body>
</html>