<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <title>上传数据管理</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<link rel="stylesheet" type="text/css" href="../../resources/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../resources/images/style.css" />
    <link rel="stylesheet" type="text/css" href="../../resources/css/myloading.css" />
	<link rel="stylesheet" type="text/css" href="../../resources/css/easyui.css"/>
	<style>
		html{height: 100%}
		td{text-align:center;}
		th{text-align:center !important ; }
		.optBtn button{margin-right:10px;}
		.optBtn a{margin:0 5px;}
		#search_text{height: 30px; border-radius:6px;}
		.tabField{width:570px;margin-left:80px;margin-top:5px;}
		.edit-content input{width: 100%}
		#is_modified{display: none}
		.input-rowspan{width:100px;border:1px solid #95B8E7; height: 30px; padding:0 4px;  outline-style: none; resize: none; -moz-border-radius: 5px 5px 5px 5px; -webkit-border-radius: 5px 5px 5px 5px; border-radius: 5px 5px 5px 5px;}
		#modal_add .row>p{text-align: right; }
		.updata{margin-top: 10px}
		.container-fluid>div{margin:10px};
		.input-dropdown{width:85%;height:16px;text-align:center;}
		.div-dropdown{display:inline-block;vertical-align: middle;text-align:left;width:150px;}
		p.col-xs-2{padding:0;width:11%}
		.row{margin-bottom: 10px}
	</style>
</head>
<body>
<div class="loading">
		<div class="sk-circle">
		  <div class="sk-circle1 sk-child"></div>
		  <div class="sk-circle2 sk-child"></div>
		  <div class="sk-circle3 sk-child"></div>
		  <div class="sk-circle4 sk-child"></div>
		  <div class="sk-circle5 sk-child"></div>
		  <div class="sk-circle6 sk-child"></div>
		  <div class="sk-circle7 sk-child"></div>
		  <div class="sk-circle8 sk-child"></div>
		  <div class="sk-circle9 sk-child"></div>
		  <div class="sk-circle10 sk-child"></div>
		  <div class="sk-circle11 sk-child"></div>
		  <div class="sk-circle12 sk-child"></div>
		</div>
</div>
<div class="mr15">
	<div class="mr15" id="body_main"  >
		<div class="cl_title">
			<span class="_title">上传数据管理</span>
		</div>
		<div style="margin:50px 10px 10px 0;" class="fr">
			<input type="text" id="search_text"  value="" />
			<button id="search" class="btn btn-secondary">
				<i class="ico-search fa fa-search"></i>查询</button>
			<button  class="btn btn-green" id="upload" style="margin-left: 50px">
				<i class="fa fa-upload"></i>上传</button>
		</div>
    <div style="margin-left:50px" id="table">
		<table cellspacing="0" cellpadding="0" class="list1" style="width:100%;min-width: 730px">
			<tr>
				<th style="width:4%;">序号</th>
				<th style="width:18%;">名称</th>
				<th style="width:auto;">描述</th>
				<th style="width:7%;">图表引用次数</th>
				<th style="width:5%;">字段数量</th>
				<th style="width:5%;">记录数量</th>
				<th style="width:8%;">上传时间</th>
				<th style="width:7%;">上传人</th>
				<th style="width:250px;">操作</th>
			</tr>
			<tbody id="table1" class="table"></tbody>
		</table>
	</div>
</div>
<!--上传，重传，追加模态框-->
	<div class="modal fade" id="modal_add" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="true">
		<div class="modal-dialog" style="width:720px;" >
			<div class="modal-content">
				<div class="modal-header">
					<span style="font-size: 16px" class="add-title">上传</span>
					<button type="button" class="close" data-dismiss="modal">
						<span  aria-hidden="true" >&times;</span><span class="sr-only">Close</span>
					</button>
				</div>
				<div class="modal-body">
					<div class="row">
						<p class="col-xs-2 " >名称:</p>
						<div class="col-xs-6">
							<input type="text" class="txt_inp" name="names" id="names" style="width:100%"/>
						</div>
					</div>
					<div class="row">
						<p class="col-xs-2 ">描述:</p>
						<div class="col-xs-6">
							<input type="text" class="txt_inp" name="des" id="des" style="width:100%"/>
						</div>
					</div>
					<div class="row updata-Field" >
						<p class="col-xs-2"> 数据字段:</p>
						<p class="col-xs-10"><a class="btn btn-primary addField">添加</a></p>

						<div class="col-xs-12">
							<table border="1" cellspacing="0" width="100%" class="list1 tabField" >
								<tr>
									<th width="10%">顺序</th>
									<th width="40%">名称</th>
									<th width="20%">类型</th>
									<th width="30%">操作</th>
								</tr>
								<tbody class="table" id="field-content">
								</tbody>
							</table >
						</div>
					</div>
					<div class="row updata" >
						<p class="col-xs-2">数据上传:</p>
						<div class="col-xs-4" >
							<input type="file" id="file" >
						</div>
					</div>
				</div>
				<div class="modal-footer" style="padding-right:30px;">
					<a type="button" class="btn btn-primary "   id="is_add">确定</a>
					<button type="button" class="btn btn-default "  data-dismiss="modal">取消</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Del共用模态框 -->
	<div class="modal fade" id="model_del" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="false">
		<div class="modal-dialog" style="width:300px;margin:65px auto;" >
			<div class="modal-content">
				<div class="modal-header" id="modal_title">
					<button type="button" class="close" data-dismiss="modal">
						<span class="is_true" aria-hidden="true" >&times;</span><span class="sr-only">Close</span>
					</button>
				</div>
				<div class="modal-body">
					<div style="height:65px;text-align: center;font-size: 18px" id="txt_insert">
						<span >确定删除吗?</span>
					</div>
				</div>
				<div class="modal-footer" style="text-align:right;">
					<button type="button" class="btn btn-primary " data-dismiss="modal" id="Del">确定</button>
					<button type="button" class="btn btn-default is_false" data-dismiss="modal">取消</button>
				</div>
			</div>
		</div>
	</div>
	<!-- 字段编辑的模态框 -->
	<div class="modal fade" id="modal_fieldEdit" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="false">
		<div class="modal-dialog" style="width:300px;margin:65px auto;" >
			<div class="modal-content">
				<div class="modal-header" >
					<button type="button" class="close" data-dismiss="modal">
						<span class="is_true" aria-hidden="true" >&times;</span><span class="sr-only">Close</span>
					</button>
				</div>
				<div class="modal-body">
					<div style="text-align: center;font-size: 15px;line-height:32px;"  id="field-pannel">
						<div>
							<span>名称:</span>
							<input type="text" id="fieldName" class="txt_inp" title="请选择" placeholder="请填写字段名称" autocomplete="off" />
						</div>
						<div >
							<span>类型:</span>
							<div style="position:relative;display: inline-block;">
								<input type="hidden" id="fieldType" name="fieldType" value=""/>
								<input type="text" id="_fieldType" class=" inp dd txt_inp" title="请选择" placeholder="请选择字段类型" autocomplete="off" data-to="fieldType" data-type="json" data-src="_json_fieldTypeArr" onkeydown="return false;"/>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer" style="text-align:right;">
					<button type="button" class="btn btn-primary edit-field" data-dismiss="modal">确定</button>
					<button type="button" class="btn btn-default " data-dismiss="modal">取消</button>
				</div>
			</div>
		</div>
	</div>

	<!-- 预览共用模态框 -->
<div class="modal fade" id="modal_pre" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="false">
	<div class="modal-dialog" style="width:400px;margin:65px auto;" >
		<div class="modal-content">
			<div class="modal-header"  style="padding: 5px 15px;">
				<span>预览</span>
				<label for="search-num" style="padding-left: 30px">查看数量(条)：</label>
				<input type="number" id="search-num" min="5" value="10"  class="input-rowspan" >
				<button type="button" class="close" data-dismiss="modal">
					<span class="is_true" aria-hidden="true" >&times;</span><span class="sr-only">Close</span>
				</button>

			</div>
			<div class="modal-body">
				<table border="1" id="preTab" cellspacing="0" width="100%" class="list1">
					<tr>
						<th width="40%">字段</th>
						<th width="20%">类型</th>
					</tr>
					<tr>
						<td class="edit-content">检查数</td>
						<td class="edit-content">数字</td>
					</tr>
					<tr>
						<td class="edit-content">阳性率</td>
						<td class="edit-content">数字</td>
					</tr>
				</table>
			</div>
			<div class="modal-footer" style="text-align:center;">
				<button  class="btn btn-secondary" id="upPage">上一页</button>
				<button  class="btn btn-green"  id="downPage">下一页</button>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript" src="../../resources/js/tangram-min.js"></script>
<script type="text/javascript" src="../../resources/js/tangram-ext.js"></script>
<script type="text/javascript" src="../../resources/lib/echarts/echarts.min.js"></script>
<script type="text/javascript" src="../../resources/lib/echarts/macarons.js"></script>
<script type="text/javascript" src="../../resources/js/baiduTemplate.js"></script>
<script type="text/javascript" src="../../resources/js/mchart.js"></script>
<script type="text/javascript" src="../../resources/jQuery/jquery.min.js"></script>
<script type="text/javascript" src="../../resources/js/bootstrap.js"></script>
<script src="../../resources/jQuery/jquery.easyui.min.js"></script>
<!--上传的数据模板-->
<script id="tpl12" type="text/template">
		[%	var j=1;
		for(var i in list){%]
		<tr>
			<td class="order">[%=j%]</td>
			<td >[%=list[i].name%]</td>
			<td >[%=list[i].des%]</td>
			<td >[%=list[i].chatTimes%]</td>
			<td>[%=list[i].fieldCounts%]</td>
			<td>[%=list[i].recorderCounts%]</td>
			<td>[%=list[i].uploadTimes%]</td>
			<td>[%=list[i].uploadPerson%]</td>
			<td class="optBtn">
				<button class="btn btn-primary edit"   data-echo="[%=list[i].id%]">预览</button>
				<button class="btn btn-red delModel">删除</button>
				<button class="btn btn-primary">重传</button>
				<button class="btn btn-primary">追加</button>
			</td>
		</tr>
		[%j++;}%]
</script>
<!--预览模板-->
<script id="tpl13" type="text/template">
	<tr>
		<td >序号</td>
		<td >名称</td>
		<td >数值</td>
	</tr>
		[%
	        var endNum=parseInt(window.localStorage.endNum);
	        var startNum=parseInt(window.localStorage.startNum);
		for(var i=startNum;i<endNum;i++){
	        var j=i-1;
	%]
		<tr>
			<td class="pre_order">[%=i%]</td>
			<td >[%=list[j].name%]</td>
			<td >[%=list[j].val%]</td>
		</tr>
		[%j++;}%]
</script>
<!--字段模板-->
	<script id="tpl14" type="text/template">
		[%for(var i in list){%]
		<tr>
			<td>[%=parseInt(i)+1%]</td>
			<td class="edit-content">[%=list[i].name%]</td>
			<td class="edit-content">[%=list[i].type%]</td>
			<td class="optBtn panelBtn">
				<a class="btn btn-primary ">编辑</a>
				<a class="btn btn-red ">删除</a>
			</td>
		</tr>
		[%}%]

	</script>
<script>
	/* 设置主体内容最小高度 */
	var main_h=$('#mainframe', parent.document).height();
	var min_H=main_h-15;
	$("#body_main").css("min-height",min_H);

    var $name=$("#names"),
		$table1=$("#table1"),
        $des=$("#des"),
        $alertAdd=$("#modal_add"),
        $alertModal=$("#model_del"),
		stateFlag="",/*用于储存状态（重传，追加，上传）,用于模态框*/
    	$upload=$("#upload");
		/*加载已经上传的数据*/
		$.ajax({
			url:"../../resources/ajax/tree6.json",
			success:function (data) {
			    $(".loading").hide();
				$("#table1").html(baidu.template("tpl12",data));
			}
		});
	/*点击上传按钮*/
    $upload.click(function () {
		$("#field-content").html(null);
    	/*解除按钮禁用*/
    	$(".updata").show();
        $(".panelBtn").children("a").removeAttr("disabled");
        $name.removeAttr("disabled");
        $des.removeAttr("disabled");
        $name.val(null);
        $des.val(null);
		stateFlag="上传";
        $alertAdd.modal("toggle");
		$(".add-title").html(stateFlag);
		/*获取字段数据*/
		/*$.ajax({
			url:"../../resources/ajax/updata_field.json",
			success:function (data) {
				T("#field-content").html(baidu.template("tpl14",data));
			}
		})*/
    });
	/*点击模态框按钮，默认完成字段编辑*/
  /*  $(".modal-footer").children().click(function () {
        var $is_edit=$(".is_edit");
        if($is_edit.length){
            finishEdit($(".is_edit"));
        }
    });*/
	/*模态框的确认按钮事件*/
    $("#is_add").click(function () {
        switch (stateFlag){
			case "上传":
                var docName= $name.val(),
                docDes= $des.val(),
                time=new  Date(),
               vMon = time.getMonth() + 1,
               vDay = time.getDate(),
               saveTime= time.getFullYear() +"-"+ (vMon < 10 ? "0" + vMon : vMon) +"-"+ (vDay < 10 ? "0" + vDay : vDay);
           if(!docName){
               alert("填写名称!");
               return ;
           }
           var _add='<tr> <td class="order"></td> <td >'+docName+'</td> <td >'+docDes+'</td> <td >4</td> <td>2</td> <td>3</td> <td>'+saveTime+'</td> <td>财务部</td> <td class="optBtn "> <button class="btn btn-primary edit"  >预览</button> <button class="btn btn-red delModel">删除</button> <button class="btn btn-primary">重传</button> <button class="btn btn-primary">追加</button> </td> </tr>';
           $table1.append(_add);
			/*添加新的一项后重新按顺序排序*/
            order();
				break;
			case "重传":
				$table1.children().eq(trID).children().eq(1).html($name.val());
				$table1.children().eq(trID).children().eq(2).html($des.val());
				break;
			case "追加":
				break;
		}
	   $alertAdd.modal("hide");
    });
</script>
<script>
	/*报告操作*/
	var trID;/*点击重传或是追加时，把当前行的索引赋值给trID*/
	var num=window.localStorage.endNum=11;
	window.localStorage.startNum=1;/*用于预览时，上一页和下一页*/
	$("#table1").on("click","button",function () {
	    var self=$(this);
        var id=this.getAttribute("data-echo");
        var nameVal=$(this).parent().siblings("td").eq(1).html();
        var desVal=$(this).parent().siblings("td").eq(2).html();
		$(".updata").show();
	    switch (this.innerHTML){
			case "预览":
				$("#modal_pre").modal("show");
				$.ajax({
					url:"../../resources/ajax/pretab.json",
					success:function (data) {
						var length=data.list.length;
						$("#preTab").html(baidu.template("tpl13",data));
						/*上下页跳转，有后台数据后需要重新写*/
						$("#upPage").click(function () {
							var searchNum=parseInt($("#search-num").val());
							var _id=$(".pre_order").first().html();
							var startNum=parseInt(_id)-searchNum;
								startNum=startNum<1?(length-length%searchNum)+1:startNum;
							var endNum=startNum+searchNum;
								endNum=endNum>(length+1)?(length+1):endNum;
							window.localStorage.startNum=startNum;
							window.localStorage.endNum=endNum;
							$("#preTab").html(baidu.template("tpl13",data));
						})
						$("#downPage").click(function () {
							var searchNum=parseInt($("#search-num").val());
							var _ide=$(".pre_order").last().html();
							var startNum=parseInt(_ide)+1;
							startNum=startNum>length?1:startNum;
							var endNum=startNum+searchNum;
							endNum=endNum>=(length+1)?(length+1):endNum;
							window.localStorage.startNum=startNum;
							window.localStorage.endNum=endNum;
							$("#preTab").html(baidu.template("tpl13",data));
						})
					}
				});
			    break;
            case "删除":
                $alertModal.modal("toggle");
				$("#Del").unbind();
                $("#Del").click(function () {
                    self.parent().parent().remove();
					/*删去后重新排序*/
					order();
                });
                break;
            case "重传":
                stateFlag="重传";
                $(".panelBtn").children("a").removeAttr("disabled");
                $name.removeAttr("disabled");
                $des.removeAttr("disabled");
                $name.val(nameVal);
                $des.val(desVal);
                $alertAdd.modal("toggle");
				trID=$table1.children().index($(this).parent().parent());/*找到当前重传的是哪一项*/
				$("#field-content").html(null);
				$.ajax({
					url:"../../resources/ajax/updata_field.json",
					success:function (data) {
						T("#field-content").html(baidu.template("tpl14",data));
						$(".panelBtn").children("a").attr({"disabled":"disabled"});
					}
				})
                break;
            case "追加":
            	stateFlag="追加";
				var is_new=this.getAttribute("echo-data");
				if(is_new){
					$("#field-content").html(null);
				}else{
					/*获取字段数据*/
					$.ajax({
						url:"../../resources/ajax/updata_field.json",
						success:function (data) {
							T("#field-content").html(baidu.template("tpl14",data));
							 $(".panelBtn").children("a").attr({"disabled":"disabled"});
						}
					})
				}
                $name.attr({"disabled":"disabled"});
                $des.attr({"disabled":"disabled"});
                $(".updata").hide();
                $name.val(nameVal);
                $des.val(desVal);
                $alertAdd.modal("toggle");
                break;
		}
		$(".add-title").html(stateFlag);
    });
	/*完成编辑*/
    function finishEdit(btn) {
        var editContent=btn.parent().siblings(".edit-content");
        var fieldVal=$(editContent[0]).children("input").val();
        var fieldType=$(".typeTree").combobox("getText");
        editContent[0].innerHTML=fieldVal;
        editContent[1].innerHTML=fieldType;
        btn.html("编辑");
        btn.removeClass("is_edit");
    }
    /*排序，当删除或增加时，序号自动按顺序排列*/
    function order(){
    	var $order=$(".order");
		for (var i = 0; i < $order.length; i++) {
			$order[i].innerHTML=i+1;
		}
	}
    var orderId="";
	var is_fieldAdd=true;/* 用于判断是字段添加，还是字段编辑 */
	var fieldTrID=0;/*用于编辑字段时,储存编辑的是哪一个*/
	var _json_fieldTypeArr=[{id:1,text:"数字"},{id:2,text:"字符串"}];/*字段类型数组*/
	T('#_fieldType').dropdown({width:"182px"});
	/*点击添加字段*/
	$(".addField").click(function () {
		is_fieldAdd=true;
		$("#modal_fieldEdit").modal("toggle");
		$("#field-pannel input").val(null);
	})
	/*点击字段编辑按钮*/
	$("#field-content").on("click","a",function () {
		var $is_edit=$(".is_edit");
		var self=$(this);
		var editContent=$(this).parent().siblings(".edit-content");
		fieldTrID=$("#field-content tr").index($(this).parent().parent());/*找到编辑的是那一个  */
		orderId=$(this).parent().siblings().eq(0).html();
		switch (this.innerHTML){
			case "编辑":
				is_fieldAdd=false;
				$("#modal_fieldEdit").modal("toggle");
				var filed_name=editContent[0].innerHTML;
				var filed_type=editContent[1].innerHTML;
				$("#field-pannel input").eq(0).val(filed_name);
				$("#field-pannel input").eq(2).val(filed_type);
				break;
			case "删除":
				$alertModal.modal("toggle");
				$("#Del").unbind();
				$("#Del").click(function () {
					self.parent().parent().remove();
					for(var i=0; i<rows.length; i++){
						if(orderId==rows[i].orderId){
							alert(orderId);
							rows.splice(i,1);
						}
					}
				});
				break;
		}
	});

	/* 字段编辑机的模态框的确认按钮 */
	$(".edit-field").click(function(){
		var fieldName=$("#field-pannel input").eq(0).val();
		var fieldTypeID=$("#field-pannel input").eq(1).val();
		var fieldType=$("#field-pannel input").eq(2).val();
		/*获取添加前最后一位的序号*/
		var length=$("#field-content").children().last().children().html();
		length=length==undefined?0:length;
		if(is_fieldAdd){/* 添加字段 */
			//定义一个列对象放入列对象数组中
			var row = {'physicalName':fieldName, 'orderId':(parseInt(length)+1)+"", 'rowType':fieldTypeID};
			var str='<tr> <td>'+(parseInt(length)+1)+'</td> <td class="edit-content">'+fieldName+'</td> <td class="edit-content">'+fieldType+'</td><td class="optBtn panelBtn"> <a class="btn btn-primary ">编辑</a> <a class="btn btn-red ">删除</a> </td> </tr>';
			$("#field-content").append(str);
			rows.push(row);
		}else{/*编辑字段 */
			var thisTr=$("#field-content").children().eq(fieldTrID);
			thisTr.children().eq(1).html(fieldName);
			thisTr.children().eq(2).html(fieldType);
			for(var i=0; i<rows.length; i++){
				if(orderId==rows[i].orderId){
					rows[i].physicalName = fieldName;
					rows[i].rowType = fieldTypeID;
				}
			}
		}
	})
</script>
</body>
</html>
