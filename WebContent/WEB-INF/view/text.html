<%@ page language="java" contentType="text/html; charset=UTF-8"
pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
    <title>目录及文章正文包括菜单编辑</title>
    <%@ include file="/jsp/headerfile.jsp" %>
    <style>
        html, body {
            height: 100%;
        }

        .layouts {
            padding: 1% 15px 0 276px;
            height: 99%;
            z-index: 3;
            overflow: hidden;
        }

        .layouts > div {
            float: left;
            height: 100%;
            background: white;
        }

        .layouts:after {
            content: ".";
            display: block;
            height: 0;
            clear: both;
            overflow: hidden
        }

        .layout-right {
            position: relative;
            width: 100%;
            min-width: 600px;
            border- radius: 10px;
            overflow: hidden
        }

        .layout-center {
            width: 2px;
            border: 1px solid #0081c2;
            margin-left: -10px;
            cursor: col-resize;
        }

        .layout-left {
            padding: 10px;
            margin-left: -266px;
            width: 256px;
            border- radius: 10px 0 0 10px;
            overflow-y: auto;
            overflow-x: hidden
        }

        /*左侧菜单样式*/
        #menuTree {
            border: 2px solid #d3d3d3;
            overflow: hidden
        }

        div.tree-node {
            border-bottom: 1px solid #d3d3d3;
            padding: 5px 0;
            height: 34px;
            border-bottom: 1px solid #d3d3d3;
            line-height: 22px;
        }

        div.tree-node-selected {
            background: #e3e3e3;
        }

        span.tree-title {
            font-size: 14px;
            white-space: nowrap;
        }

        span.tree-icon {
            display: none
        }

        /*左侧菜单样式完*/
        .reportTitle {
            width: 100%;
            height: 34px;
            border-bottom: 3px solid #0081c2;
            line-height: 34px;
        }

        .reportTitle > div {
            float: left;
            margin-left: 30px
        }

        .reportTitle div:last-child {
            float: right;
            margin-right: 30px
        }

        .font-set {
            font-weight: 600;
            color: #2081b8;
        }

        /*报告的内容样式*/
        div.box {
            padding: 10px 30px;
            position: relative;
            min-width: 600px;
            height: 90%;
            overflow-y: scroll;
            overflow-x: hidden
        }

        div.box > ul {
            font-size: 15px;
            line-height: 25px;
        }

        div.box > ul > li > p {
            padding: 10px 0
        }

        div.box table {
            margin: 15px auto;
            width: 100%;
            min-width: 600px;
            border: solid 1px #d3d3d3;
            color: #000;
            border-collapse: collapse;
        }

        div.box table th {
            padding: 4px 5px;
            background-color: #f6fbfe;
            border: solid 1px #d3d3d3;
            text-align: center;
            font-weight: 600;
            color: #7e7e7e;
        }

        div.box table td {
            padding: 4px 5px;
            background-color: #fff;
            border-bottom: solid 1px #d3d3d3;
            border-right: solid 1px #d3d3d3;
            text-align: center
        }

        div.box table tr:hover > td {
            background-color: #ffd;
        }

        tr {
            height: 40px
        }

        caption {
            padding: 5px;
            border: solid 1px #d3d3d3;
            border-bottom: none;
            color: #7e7e7e;
        }

        .indent {
            text-indent: 3rem
        }

        .temp-variate {
            color: black;;
            font-weight: bold
        }

        /*报告的内容样式完*/
    </style>

</head>
<body>
<div class="layouts" id="body_main">
    <div class="layout-left">
        <p class="font-set" id="tip">*进入编辑器后右键可以编辑目录!</p>
        <ul id="menuTree"></ul>
        <!-- 右键菜单内容 -->
        <div id="_menu" class="easyui-menu" style="width:120px;display:none">
            <div onclick="_menu.newFile(0)" data-options="iconCls:'icon-save'"
                 id="new_chapter">新建章节
            </div>
            <!--  <div onclick="_menu.newFile(1)" data-options="iconCls:'icon-
 save'">新建文件夹</div> -->
            <div onclick="_menu.rename()">重命名</div>
            <div onclick="_menu.remove()" data-options="iconCls:'icon-print'">删
                除
            </div>
        </div>
    </div>
    <div class="layout-center"></div>
    <div class="layout-right">
        <div class="reportTitle clearfix">
            <div class="font-set">
                <span>XX人民医院</span>
                <span class="report-type">模版报告1</span>
                <span class="title"></span>
            </div>
            <div>
                <button type="submit" class="btn btn-primary" style="display:
none" id="edit">编 辑
                </button>
                <span class="sub-title font-set" style="display: none">医教部质控
科制</span>
            </div>
        </div>
        <iframe id="editTools" frameborder="0" style="padding:0
20px;width:100%;height:95%;display:none"></iframe>
        <div class="box"></div>
        <div class="loading" style="position: absolute;top:0">
            <div class="sk-circle">
                <div class="sk-circle1 sk-child"></div>
                <div class="sk-circle2 sk-child"></div>
                <div class="sk-circle3 sk-child"></div>
                <div class="sk-circle4 sk-child"></div>
                <div class="sk-circle5 sk-child"></div>
                <div class="sk-circle6 sk-child"></div>
                <div class="sk-circle7 sk-child"></div>
                <div class="sk-circle8 sk-child"></div>
                <div class="sk-circle9 sk-child"></div>
                <div class="sk-circle10 sk-child"></div>
                <div class="sk-circle11 sk-child"></div>
                <div class="sk-circle12 sk-child"></div>
            </div>
        </div>

    </div>
</div>

<!--删除模态框-->
<div class="modal fade" id="modal_alert" tabindex="-1" role="dialog" aria-
     labelledby="myModalLabel" aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog" style="width:300px;margin:65px auto;">
        <div class="modal-content">
            <div class="modal-header" id="modal_title">
                <span id="_title" style="color: white;">新建</span>
                <button type="button" class="close" data-
                        dismiss="modal">
					<span class="is_true" aria-hidden="true"
                    >&times;</span><span class="sr-only">Close</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="height:65px;text-align: center;font-
size: 18px" id="is_del">
                    <span>确定删除吗?</span>
                </div>
                <div id="is_new">
                    <span>名称：</span><input type="text"
                                           id="file" class="txt_inp" title="请选择" value="" autocomplete="off"/>

                </div>
            </div>
            <div class="modal-footer" style="text-align:right;">
                <button type="button" class="btn btn-primary "
                        data-dismiss="modal" id="is_true">确定
                </button>
                <button type="button" class="btn btn-default
is_false" data-dismiss="modal">取消
                </button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    /*左侧菜单宽度改变事件 */
    var limitjson = {};
    var $layout = $(".layouts"), $layLeft = $(".layout-left"), $layCenter = $(".layout-
    center
    "),$doc=$(document);
    $layCenter.mousedown(function () {
        $doc.mousemove(function (e) {
            var delX = e.clientX;
            $layout.css("paddingLeft", delX + 10 + "px");
            $layLeft.css({"marginLeft": -delX + "px", "width": delX - 10 + "px"});
            if (delX > 612) {
                $(this).unbind("mousemove");
                $layout.css("paddingLeft", "620px");
                $layLeft.css({"marginLeft": "-610px", "width": "600px"});
            } else if (delX < 208) {
                $(this).unbind("mousemove");
                $layout.css("paddingLeft", "220px");
                $layLeft.css({"marginLeft": "-210px", "width": "200px"});
            }

        });
    })
    $doc.mouseup(function () {
        $(this).unbind("mousemove");
    });
    $doc[0].ondragstart = $doc[0].onselectstart = function () {
        return false;
    }
    var o_id = parent.o_id;//获取iframe 内联框架的父级页面(左侧菜单的子节点)的点击事件
    的id
    /* 设置主体内容最小高度 */
    var main_h = $('#mainframe', parent.document).height();
    var min_H = main_h - 15;
    $("#body_main").css("min-height", min_H);
    var $edit = $("#edit");
    var $subTitle = $(".sub-title");
    var $box = $(".box");
    var $tip = $("#tip");
    var report_id = "${report_id}";
    var is_edit =${isEdit};//-1编辑 >0浏览
    var _Url;
    var node_id = "";
    /* 保存选中的节点的id */
    if (is_edit >= 0) {
        $edit.hide();
        $tip.hide();
        $subTitle.show();
        _Url = "report" + report_id;
    } else {
        $edit.show();
        $tip.show();
        $subTitle.hide();
        _Url = "model" + report_id;
    }
    $(".report-type").html("模板报告" + report_id);
    var $menuTree = $("#menuTree"), $editTools = $("#editTools"), node_lev = 0/*
     储存节点层级 */;

    var CatalogLimit = {};
    /*目录格式 */

    T.getJson("${ctx}/report/getCatalog?report_id=" + report_id, function
                    (data) {
                $menuTree.tree({
                    data: data,
                    animate: true,
                    onLoadSuccess: function (data) {
                        var self = $(this);
                        localStorage.editState2 = "false";

                        T.getJson("${ctx}/report/getfirstParagraph?
                        report_id = "+report_id, function(datas) {//刚进来默认浏览第一个有内容的页面
                        if (!datas) {
                            var root = self.tree("getRoot");
                            self.tree("select", root.target);
                            node_id = root.id;
                        } else {
                            var nodeID = datas.catalog_id;
                            var node = self.tree("find", nodeID);
                            self.tree("select", node.target);
                            node_id = nodeID;
                            var reg = /\[%\w+%]/g;
                            $box.html(datas.content.replace(reg, "_____"));

                        }
                        $(".loading").hide();

                    })
            },
            onClick
    :
    function (node) {
        //编辑
        node_id = node.id;
        if (localStorage.editState2 == "edit") {
            /* 	 $editTools
             [0].src="${ctx}/report/toUeditor?report_id="+report_id; */
            $("#editTools")
                    [0].contentWindow.loadContent(node_id);
            $(".title").html(node.text);
        } else {//浏览
            $(".loading").show();
            $.ajax({
                url: "${ctx}/report/getParagraph?
                catalog_id = "+node.id,
            success:function (res) {
                $(".loading").hide();
                var reg = /\[%\w+%]/g;
                $box.html(res.replace(reg, "_____"));
            }
        ,
            error:function () {
                $(".loading").hide();
                $box.html("");
            }
        })
        }
    }
    ,
    onDragEnter:function (e, source) {

    }
    ,
    onContextMenu:function (e, node) {/*右键菜单出现 */
        if (localStorage.editState2 == "edit") {/*进入编辑器
         才可用右键菜单,要是想在其他状态用 ,把==edit去掉就可以*/
            e.preventDefault();
            $("#new_chapter").show();
            console.log(node.target, "target");
            $menuTree.tree('select', node.target);
            /* 右
             键的时候也像左键一样选中*/
            node_lev = easyui_tree_options.getLevel(this,
                    node);
            /* 获取节点层级 */
            if (node_lev >= CatalogLimit.depth) {/* 判断层级
             是否超出 */
                $("#new_chapter").hide();
            }

            $("#_menu").menu("show", {
                left: e.pageX,
                top: e.pageY
            })
        }

    }
    })
    ;
    })
    ;
    var easyui_tree_options = {
        length: 0,  //层数
        getLevel: function (treeObj, node) { //treeObj为tree的dom对象，
            node为选中的节点
            while (node != null) {
                node = $(treeObj).tree('getParent', node.target)
                easyui_tree_options.length++;
            }
            var length1 = easyui_tree_options.length;
            easyui_tree_options.length = 0;     //重置层数
            return length1;
        }
    }

    /*编辑器*/
    var catalog_type;
    $edit.click(function () {
        var self = $(this);
        if ($(this)[0].innerHTML == "取消") {/* 没有进入编辑器 */
            $menuTree.tree("disableDnd");
            /*禁止拖拽  */
            $editTools.hide();
            $box.show();
            self[0].innerHTML = "编辑";
            window.localStorage.editState2 = "false";
        } else {/* 进入编辑器 */
            var rootID = $menuTree.tree("getRoot").id;
            console.log(rootID);
            T.getJson("${ctx}/report/getCatalogLimit?
            catalog_id = "+rootID,function(data){
            //CatalogLimit=data;/* 得到目录格式 */
            CatalogLimit = data;
            catalog_type = data.catalog_type;
            alert(JSON.stringify(data));
        }
        )

    $menuTree.tree("enableDnd");
    /*启用拖拽  */
    $editTools[0].src = "${ctx}/report/toUeditor?
    report_id = "+report_id;
    $editTools.load(function () {
        $(this).show();
        $box.hide();
        self[0].innerHTML = "取消";
    })
    }
    })
    /*右键菜单操作  */

    var $modalTitle = $("#_title"),
            $modal = $("#modal_alert"),
            $del_modal = $("#is_del"),
            $new_modal = $("#is_new"),
            $is_ture = $("#is_true"),
            $file_inp = $("#file");

    var _menu = {
        node: function () {/*获取右键的节点  */
            return $menuTree.tree("getSelected");
            /*选中的节
             点  */
        },
        rename: function () {/*重命名  */
            $modalTitle.html("重命名");
            $modal.modal("toggle");
            $del_modal.hide();
            $new_modal.show();
            var nodes = this.node();
            var inpARR = nodes.text.split(".");
            $file_inp.val(inpARR[1]);
            $is_ture.unbind();
            $is_ture.click(function () {
                var inp_txt = inpARR[0] + $file_inp.val();
                var formData = new FormData();
                formData.append("catalog_id", nodes.id);
                formData.append("catalog_name", inp_txt);
                $.ajax({
                    url: '${ctx}/report/renameCatalog',
                    type: 'post',
                    cache: false,
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (result) {
                        $menuTree.tree
                        ("update", {"target": nodes.target, "text": inp_txt});
                    }
                });
            });
        },
        newFile: function (even) {/*新文件 */
            $modal.modal("toggle");
            var self = this;
            //var _title=even==1?"新建文件夹":"新建章节";
            $modalTitle.html(_title);
            $del_modal.hide();
            $new_modal.show();
            $is_ture.unbind();
            var fileName = $file_inp.val(null);

            $file_inp.blur(function () {

                var reg = /^[0-9a-zA-Z\. \、\(\（\[\【\。]/;
                var regTxt = $file_inp.val().match(reg);
                if (regTxt) {
                    alert("文件名开头不能 有 " + regTxt);
                    return;
                }
            })

            if (this.node().children.length != 0) {
                var lastChild = this.node().children.pop(), order = "";
                lastChildText = lastChild.text;
                var rules = CatalogLimit.tree [node_lev].catalog_name;
                /* 判断是否有点 */
                if (lastChildText.indexOf(".")
                        < 0) {
                    console.log
                    (lastChildText)
                    var end = rules
                            [rules.length - 2];

                    end = lastChildText.indexOf(end);

                    order = lastChildText.substring(1, end);
                } else {
                    var
                            str = lastChildText.split(".")[0];
                    console.log(str, rules);
                    if (rules[0] == "%") {
                        order = str;
                    } else {

                        order = str.substring(1, str.length - 1);
                    }

                }
            } else {
                order = 0;
            }
            $is_ture.click(function () {
                var fileName = $file_inp.val();
                if (!fileName) {
                    return;
                }
                /*switch(even){
                 case 1:
                 arr=
                 [{"text":fileName,"children":[{"text":"新文件"}]}];
                 break;
                 default:
                 arr=
                 [{"text":fileName,"children":[]}];
                 break;
                 };*/
                /*if(self.node().children && self.node
                 ().children.length!=0){
                 $menuTree.tree("append",{
                 parent:self.node
                 ().target,
                 data:arr,
                 })
                 }else{ */
                /*  $menuTree.tree("insert",{
                 after:self.node
                 ().target,
                 data:arr,
                 }) */
                /* $menuTree.tree
                 ("append",{

                 parent:self.node().target,
                 data:arr,
                 })

                 } */
                var fd = new FormData();
                fd.append("par_catalog_id", self.node
                ().id);
                fd.append("catalog_name", fileName);
                fd.append("order", order);
                fd.append("catalog_type", catalog_type);
                fd.append("reportlist_id", report_id);
                fd.append("level", node_lev);
                $.ajax({
                    url: '${ctx}/report/addCatalog',
                    type: 'post',
                    cache: false,
                    data: fd,
                    processData: false,
                    contentType: false,
                    success: function (result) {

                        result = JSON.parse(result);
                        var arr = [];
                        arr[0] = {};

                        arr[0].id = result.catalog_id;

                        arr[0].text = result.catalog_name;

                        arr[0].children = [];

                        $menuTree.tree("append", {

                            parent: self.node().target,

                            data: arr
                        })

                    }
                });
            });
        },
        remove: function () {/*删除  */
            $modal.modal("toggle");
            $modalTitle.html("删除文件");
            var self = this;
            $new_modal.hide();
            $del_modal.show();
            $is_ture.unbind();
            $is_ture.click(function () {
                T.getJson
                ("${ctx}/report/removeCatalog?catalog_id=" + self.node().id, function (datas) {
                    $menuTree.tree("remove", self.node
                    ().target);
                })
            })
        }

    }
</script>
</body>
</html>
