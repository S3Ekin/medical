<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <title>表格创建编辑</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" type="text/css" href="../../resources/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="../../resources/images/style.css"/>
    <link rel="stylesheet" type="text/css" href="../../resources/css/easyui.css"/>
    <style>
        .optBtn button { padding: 0 8px; height: 26px; margin-right: 10px; }
        /*数据源窗口样式*/
        #sourceTree{border:2px solid #d3d3d3}
        div.tree-node{border-bottom: 1px solid #d3d3d3;height:auto;padding: 5px 0;border-bottom: 1px solid #d3d3d3;line-height: 22px;}
        div.tree-node-selected{background: #e3e3e3;}
        span.tree-title{width:auto;display: inline;}
        div.content { padding: 10px 5px;}
        div.footer button {margin-right: 10px }
        div.footer { text-align: right; }
        /*数据源窗口样式完*/
        div.row {line-height: 40px }
        .topic { text-align: right; font-size: 15px; font-weight: 700; }
        .sourceBtn { padding: 0 8px; height: 26px; }
        .zb-name { color: #2081BB; white-space: nowrap; }
        .upload { display: none }
        .table { display: none }
        .zb { display: none }
        .pre { padding: 10px 20px 20px 20px; border: 1px solid #95B8E7; display: none; margin-left: 17.7% }
        #organization { height: 30px }
        span.tree-title { font-size: 14px }
        .no-padding { padding: 0 }
        caption { padding: 0; height: 30px; font-weight: bolder }
        .combo-title { padding-right: 5px }
        .combo-data > div { display: inline-block }
        th{text-align:center !important;}
        td{text-align:center;}
        td div{width: 100%;text-overflow: ellipsis;overflow: hidden;white-space:nowrap;}
        span.combo{line-height: 23px}
        tr{height: 40px }
        .show{display: block}
        .hide{display: none}
        .input-rowspan{width:50px;border:1px solid #95B8E7; height: 30px; padding:0 4px;  outline-style: none; resize: none; -moz-border-radius: 5px 5px 5px 5px; -webkit-border-radius: 5px 5px 5px 5px; border-radius: 5px 5px 5px 5px;}
    </style>

</head>
<body>
<div class="mr15" id="body_main">
    <div class="cl_title">
        <span class="_title">表格创建编辑</span>
    </div>
    <div class="container-fluid" style="width:90%;min-width:900px;padding: 20px 0 0 0">
        <div class="row">
            <div class="col-xs-2 topic">名称:</div>
            <div class="col-xs-9">
                <input type="text" class="clo-xs-9 txt_inp" id="name" style="width:100%;max-width: 400px ;height:30px" value="表格1">
            </div>
        </div>
        <div class="row">
            <div class="col-xs-2 topic">数据源类型:</div>
            <div class="col-xs-4">
                <input type="radio" name="dataType" value="1" checked="checked"><span>指标数据</span>
                <input type="radio" name="dataType" value="0" style="margin-left: 20px"><span>上传数据</span>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-2 topic">数据源:</div>
            <div class="col-xs-2">
                <button class="btn btn-primary sourceBtn">选择(<span>多选</span>)</button>
            </div>
            <div class="col-xs-7 theme">

            </div>
        </div>
        <div class="zb">
            <div class="row">
                <div class="col-xs-2 topic" style="padding-left: 0">指标公共维度:</div>
                <div class="col-xs-7 combo-data">
                    <span class="combo-title">频率:</span>
                    <div id="rotate"></div>
                    <div class="data-combo-year" id="combo-year"></div>
                    <div>
                        <div class="data-combo"></div>
                    </div>
                    <span style="color:darkgreen">———</span>
                    <div class="data-combo-year"></div>
                    <div>
                        <div class="data-combo"></div>
                    </div>
                </div>
                <div class="col-xs-3 no-padding">
                    <span class="combo-title">科室:</span>
                    <div id="organization"></div>
                </div>
            </div>
            <div class="newAdd"></div>
            <div class="row">
                <div class="col-xs-2 topic">横轴维度:</div>
                <div class="col-xs-3">
                    <div class="wd-combo" data-options="value:'重点疾病'"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-2 topic">纵轴维度:</div>
                <div class="col-xs-4">
                    <div class="wd-combo" data-options="value:'时间'"></div>
                </div>
            </div>
        </div>
        <div class="upload">
            <div class="row">
                <div class="col-xs-2 topic">数据名称:</div>
                <div class="col-xs-10 zb-name update-name"></div>
            </div>
            <div class="row">
                <div class="col-xs-2 topic ">横轴字段:</div>
                <div class="col-xs-4">
                    <div class="field-combo" data-options="value:'时间'"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-2 topic">纵轴字段:</div>
                <div class="col-xs-4">
                    <div class="field-combo" data-options="value:'科室'"></div>
                </div>
            </div>

        </div>
        <div class=" table">
            <div class="row">
                <div class="col-xs-2 topic">图形参数:</div>
                <div class="col-xs-10 no-padding">
                    <div class="col-xs-3" style="width: 86px">表头合并</div>
                    <div class="col-xs-2 no-padding">
                        <input type="radio" name="rowspan" value="1" checked="checked"><span>是</span>
                        <input type="radio" name="rowspan" value="0" style="margin-left: 20px"><span>否</span></div>
                    <div class="col-xs-7 tab-merge">
                        <span>合并行数:</span>
                        <input type="number" class="input-rowspan"  value="2" min="0">
                        <span style="padding-left: 10px">合并列数:</span>
                        <input type="number" class="input-rowspan"  value="0" min="0">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-2 topic">
                    <button type="button" class="btn btn-primary " id="preChat">预览</button>
                </div>
                <div class="col-xs-10 " style="padding: 0">
                    <button type="button" class="btn btn-green " id="save" style="display:none">保存</button>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-10 pre" ></div>
            </div>

        </div>
    </div>


</div>
<!-- 数据源 -->
<div id="sourceSelected" style="display: none" data-options="footer:'#ft'">
    <div class="content">
        <ul id="sourceTree">
        </ul>
    </div>
</div>
<div id="ft">
    <div class="footer">
        <button type="button" class="btn btn-primary " id="select">确定</button>
        <button type="button" class="btn btn-default" id="cancel">取消</button>
    </div>
</div>
<!-- alert共用模态框 -->
<div class="modal fade" id="modal_alert" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"
     data-backdrop="false">
    <div class="modal-dialog" style="width:300px;margin:65px auto;">
        <div class="modal-content">
            <div class="modal-header" id="modal_title">
                <button type="button" class="close" data-dismiss="modal">
                    <span class="is_true" aria-hidden="true" >&times;</span><span
                        class="sr-only">Close</span>
                </button>

            </div>
            <div class="modal-body">
                <div style="height:65px;text-align: center;font-size: 18px" id="txt_insert">
                    <span>确定删除吗?</span>
                </div>
            </div>
            <div class="modal-footer" style="text-align:center;">
                <button type="button" class="btn btn-primary " data-dismiss="modal" id="is_true">确定</button>
                <button type="button" class="btn btn-primary is_false" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="../../resources/js/tangram-min.js"></script>
<script type="text/javascript" src="../../resources/js/tangram-ext.js"></script>
<script type="text/javascript" src="../../resources/jQuery/jquery.min.js"></script>
<script type="text/javascript" src="../../resources/js/bootstrap.js"></script>
<script src="../../resources/echarts/echarts.js"></script>
<script src="../../resources/jQuery/jquery.easyui.min.js"></script>
<script>
    /*  $.fn.combobox.defaults.filter = function(q, row){
     var opts = $(this).combobox('options');
     return row[opts.textField].indexOf(q) >= 0;
     }*/
</script>
<script>
    /* 设置主体内容最小高度 */
    var main_h=$('#mainframe', parent.document).height();
    var min_H=main_h-15;
    $("#body_main").css("min-height",min_H);

    var $radio = $("input[name=dataType]"),
        $sourceSlect = $(".sourceBtn span"),
        $zbName = $(".zb-name"),
        is_zb = true,
        $zb = $(".zb"),
        $newAdd = $(".newAdd"),
        $org = $("#organization"),
        $upload = $(".upload"),
        $table = $(".table"),
        $dataCombo = $(".data-combo"),
        $yearCombo = $(".data-combo-year"),
        $sourceSelected = $("#sourceSelected"),
        $sourceBtn = $(".sourceBtn");

    /*日期选择*/
    var year_f, year_last, year_s;
    var yearArr = [];
    var month = [
        {id: '1', text: '1月'},
        {id: '2', text: '2月'},
        {id: '3', text: '3月'},
        {id: '4', text: '4月'},
        {id: '5', text: '5月'},
        {id: '6', text: '6月'},
        {id: '7', text: '7月'},
        {id: '8', text: '8月'},
        {id: '9', text: '9月'},
        {id: '1', text: '10月'},
        {id: '11', text: '11月'},
        {id: '12', text: '12月'}
    ];
    var roteArr = [{"id": 1, "text": "年份"},
        {"id": 2, "text": "季度"},
        {"id": 3, "text": "月份"}];/*频率选择数组*/
    var season = [
        {id: '1', text: '一季度'},
        {id: '2', text: '二季度'},
        {id: '3', text: '三季度'},
        {id: '4', text: '四季度'}
    ];/*季度*/
    getYears();/*获得近4年*/
    function getYears() {
        var nowDate = new Date();
        year_f = nowDate.getFullYear();
        year_last = year_f - 1;
        year_s = year_f - 3;
        var id, text;
        for (var y = year_f; y >= year_s; y--) {
            id = y.toString();
            text = id + "年";
            yearArr.push({id: id, text: text});
        }
    }
    /*默认第二个年的数组，包含今年和去年*/
    var secondYear = yearArr.slice(0, 2);
    /*频率框加载*/
    $("#rotate").combobox({
        valueField: "id",
        textField: "text",
        data: roteArr,
        editable: false,
        width: 70,
        height: 30,
        panelWidth: 70,
        value:"3",
        panelHeight: 'auto',
        formatter: function (row) {
            return "<span class='glyphicon glyphicon-check'>&nbsp;" + row.text + "</span>"
        },
        onSelect: function (recoder) {
            if (recoder.id == 1) {/*1:频率为年；2：季节；3：月份*/
                $dataCombo.parent().hide();
            } else {
                var firstArr;
                firstArr=recoder.id==2?season:month;
                try {
                    $dataCombo.combobox("clear");
                    $dataCombo.parent().show();
                    $dataCombo.combobox("loadData", firstArr);
                    $dataCombo.combobox("setValue", "1");
                }catch (err){
                    return ;
                }
            }
        }
    });
    /*结束-月框加载*/
    $dataCombo.last().combobox({
        valueField:"id",
        textField:"text",
        data: month,
        editable: false,
        width: 80,
        height: 30,
        panelWidth: 80,
        panelHeight: 'auto',
        value:"1",
        onLoadSuccess:function(){
        },
        formatter: function (row) {
            return "<span class='glyphicon glyphicon-check'>&nbsp;" + row.text + "</span>"
        }
    });
    /*开始-月框加载*/
    ComboChange.prototype.firstMonChange = function () {
        if(this.startYear==this.endYear){
            var secondMonArr = this.getRotate().slice(this.startMon - 1);/*第二个月或季度显示的数组，从star开始*/
            $dataCombo.last().combobox("loadData", secondMonArr);
            if (this.startMon > this.endMon) {/*前面的月或季度大于后面的*/
                $dataCombo.last().combobox("setValue", this.startMon); /*同步两个*/
            }

        }else{
            var secondMonArr = this.getRotate().slice();
            $dataCombo.last().combobox("loadData", secondMonArr);/*第二个月*/
        }
    };
    $dataCombo.first().combobox({
        valueField:"id",
        textField:"text",
        data:month,
        value:"1",
        editable:false,
        width: 80,
        height: 30,
        panelWidth: 80,
        panelHeight: 'auto',
        formatter: function (row) {
            return "<span class='glyphicon glyphicon-check'>&nbsp;" + row.text + "</span>"
        },
        onSelect: function (node){
            try{
                var combo= new ComboChange(node,null,null);
                combo.firstMonChange();
            }catch(err){
                return ;
            }

        }

    });

    /*结束年份*/
    ComboChange.prototype.secondYearChange=function () {
        if(this.endYear==this.startYear){
            var secondMonArr = this.getRotate().slice(this.startMon - 1);/*第二个月或季度显示的数组，从star开始*/
            $dataCombo.last().combobox("loadData", secondMonArr);
            if(this.startMon>this.endMon){
                $dataCombo.last().combobox("setValue", this.startMon); /*同步两个*/
            }
        }else{
            $dataCombo.last().combobox("loadData", this.getRotate());
        }
    };
    $yearCombo.last().combobox({
        valueField: "id",
        textField: "text",
        data: secondYear,
        value: year_f,
        editable: false,
        width: 80,
        height: 30,
        panelWidth: 80,
        panelHeight: 'auto',
        formatter: function (row) {
            return "<span class='glyphicon glyphicon-check'>&nbsp;" + row.text + "</span>"
        },
        onSelect: function (node) {
            try {
                var combo=new ComboChange(null,null,node);
                combo.secondYearChange();
                console.log(combo,"enfYear");
            }catch (err){
                return ;
            }

        }
    });
    /*开始年份*/
    ComboChange.prototype.firstYearChange=function () {
        var secondYearArr=yearArr.slice(0, (year_f - this.startYear + 1));/*第二个年要加载的*/
        if (this.startYear >=this.endYear) {
            if(this.startYear!=this.endYear){
                $yearCombo.last().combobox("setValue", this.startYear);/*同步两个*/
            }
            var secondMonArr = this.getRotate().slice(this.startMon - 1);/*第二个月或季度显示的数组，从star开始*/
            console.log(secondMonArr,"ghjk");
            $dataCombo.last().combobox("loadData", secondMonArr);
            if(this.startMon>this.endMon){
                $dataCombo.last().combobox("setValue", this.startMon); /*同步两个*/
            }
        } else {
            $dataCombo.last().combobox("loadData", this.getRotate());
        }
        $yearCombo.last().combobox("loadData", secondYearArr);/*保证第二个年永远比第一个大*/
    };
    $yearCombo.first().combobox({
        valueField:"id",
        textField: "text",
        data:yearArr,
        value:year_last,
        editable: false,
        width: 80,
        height: 30,
        panelWidth: 80,
        panelHeight: 'auto',
        onLoadSuccess:function(){
        },
        formatter: function (row) {
            return "<span class='glyphicon glyphicon-check'>&nbsp;" + row.text + "</span>"
        },
        onSelect: function (node) {
            if(yearloadFinsh){
                var combo=new ComboChange(null,node,null);
                console.log(combo,"456",node.id);
                combo.firstYearChange();
            }
        }
    });
    var yearloadFinsh=true;
    function ComboChange(monNode,oneYear,twoYear){
        this.rotateId=$("#rotate").combobox("getValue");/*获取频率*/
        /*得到要操作的月或季度数组*/
        this.getRotate=function(){
            if (this.rotateId == 3) {
                return month.slice();
            } else if (this.rotateId == 2) {
                return season.slice();
            }
        };

        //第二个月
        this.endMon=parseInt($dataCombo.last().combobox("getValue"));

        //开始月
        this.startMon= monNode ? parseInt(monNode.id) : parseInt($dataCombo.first().combobox("getValue"));

        //开始年
        this.startYear=oneYear?parseInt(oneYear.id):parseInt($yearCombo.first().combobox("getValue"));

        // 结束年
        this.endYear=twoYear?parseInt(twoYear.id):parseInt($yearCombo.last().combobox("getValue"));
    }




    /*科室下拉框加载*/
    T.getJson("../../resources/ajax/org.json", function(res){
        $org.combobox({
            data:res,
            value:"",
            rules:{
                "customer":{
                    message:"请输入存在的科室！",
                    validator:function(q,_data){
                        console.log(q,"输入",$(this));
                        var flag=false;
                        for (var i = 0,leg=_data.length; i <leg; i++) {
                            if(_data[i].text==q){
                                flag=true;
                                $org.combobox("setValue",_data[i].id);
                                break;
                            }
                        }
                        return flag;
                    }
                }
            },
            /*  inputEvents:{blur:function (e) {
             console.log($org.combobox("options"));
             console.log(e.target.value,"有病！");
             var q=e.target.value;
             var n=0;
             res.forEach(function (val,index) {
             if(val.text==q){
             n=1;
             return ;
             }
             });
             if(!n){
             //                    alert("不存在");
             }

             }},*/
            validType:"customer",
            validParams:res,
//           invalidMessage:"asdf",
//           novalidate:true,
            /*   validateOnBlur:true,*/
            /*      onValidate:function (df) {
             console.log(df);
             },*/
            required:true,
            valueField: "id",
            textField: "text",
            editable: true,
            width: 120,
            height: 30,
            panelWidth: 120,
            panelHeight:"auto",
            panelMaxHeight: 300,
            missingMessage:"必须填！",
            onLoadSuccess:function (data) {
                var tr=  $(this).combobox("options");
                console.log(tr);
//                console.log($(this).combobox("options"));
            },
            /*    filter: function(q, row,e){
             var n=0;
             var opts = $org.combobox('options');
             if(q&&row["text"].indexOf(q)>=0){
             //                    $(this).combobox("setValue",row["id"]);
             //                    $(this).siblings("span").find(".textbox-text")[0].placeholder = "请选择";
             console.log(n,"过了！");
             }
             return row[opts.textField].indexOf(q) >= 0;
             },*/
            onSelect:function (da) {
                console.log($(this).siblings(".combo").children("input"),this);
//                $(this).siblings(".combo").children("input").focus();
            }
            /*  filter:function (q,row) {
             var options=$(this).combobox("options");
             /!*if(row["text"].indexOf(q)){
             console.log("sekin");
             return true;
             }*!/
             //            console.log(q,row);

             }*/
        });
    });

    /*维度框加载*/
    $(".wd-combo").combobox({
        valueField: "id",
        textField: "text",
        url: "../../resources/ajax/field_wd.json",
        method: "get",
        editable: true,
        width: 180,
        height: 30,
        panelWidth: 180,
        panelHeight: 100,
        onSelect:function () {
            var tr=  $(this).combobox("options");
            console.log(tr);
        },
        onLoadSuccess: function (data) {
//			var loadData=$(this).combobox("getData");
//			$(this).combobox("setValue",loadData[3].text);
        },
        formatter: function (row) {
            return "<span class='glyphicon glyphicon-pushpin'>&nbsp;" + row.text + "</span>"
        }
    });
    /*字段框加载*/
    $(".field-combo").combobox({
        valueField: "id",
        textField: "text",
        url: "../../resources/ajax/field_wd.json",
        method: "get",
        editable: true,
        width: 180,
        height: 30,
        panelWidth: 180,
        panelHeight: 'auto',
        onLoadSuccess: function (data) {

        },
        formatter: function (row) {
            return "<span class='glyphicon glyphicon-check'>&nbsp;" + row.text + "</span>"
        }
    });
    /*单选按钮事件*/
    $radio.on("click", function () {
        $("#save").hide();
        $(".pre").html(null);
        $(".pre").hide();
        $zbName.html(null);
        $table.hide();
        $zb.hide();
        $upload.hide();
        if ($(this).val() == 1) {
            $sourceSlect.html("多选");
            is_zb = true;
        } else {
            $sourceSlect.html("单选");
            is_zb = false;
        }
    });
    /*数据源选择按钮*/
    $sourceBtn.on("click", function () {
        $sourceSelected.window("open");
    });
    /*数据源窗口加载*/
    $sourceSelected.window({
        title: '数据源选择',
        modal: true,
        shadow: true,
        closed: true,
        width: 385,
        height:400,
        padding:10,
        resizable: true,
        minimizable: false,
        maximizable: false,
        collapsible: false,
        top: ($(window).height() - 500) * 0.5,
        left: ($(window).width() - 400) * 0.5,
        onOpen: function () {
            var urls, is_checked;
            if (is_zb) {/*true:指标数据  */
                urls = "../../resources/ajax/a1.json";
                is_checked = true;/* 可以多选 */
            } else {/*上传数据  */
                urls = "../../resources/ajax/upload.json";
                is_checked = false;/* 单选 */
            }
            // 加载窗口树
            T.getJson(urls, function(data){
                $('#sourceTree').tree({
                    data: data.data,
                    animate: true,
                    checkbox: is_checked,
                    onLoadSuccess:function ( ){
                        $(this).tree("collapseAll");
                    }
                });
            })
        }
    });
    /*指标维度加载*/
    var show_combo;
    $.ajax({
        url: "../../resources/ajax/show_type.json",
        success: function (data) {
            show_combo = data;
        }
    });
    /*指标源选择确定按钮*/
    $(".footer").on("click", "button", function () {
        switch ($(this).html()) {
            case "确定":
                var htm = "",str = "",state = is_zb ? "getChecked" : "getSelected";
                if($(".show_type").length!=0){
                    $(".show_type").combobox("destroy");/*销毁下拉面板*/
                }
                $newAdd.html(null);
                var nodes = $("#sourceTree").tree(state);/*选好的指标数组  */
                if (is_zb) {
                    if (nodes.length) {/*选择了节点*/
                        for (var i = 0, length = nodes.length; i < length; i++) {
                            var obj = nodes[i];
                            if (obj.children.length!=0) {/*是目录就跳过 */
                                continue;
                            } else {
                                var parent=$("#sourceTree").tree("getParent",obj.target);/*获取节点的父元素*/
                                var show_id;
                                if(parent.id==102010000){
                                    show_id = 1;/*重点疾病 */
                                    var _combo='<div style="float: left;padding-right: 20px">' + show_combo[show_id].type + ':' + '</div><div style="float: left;line-height: 20px" class="show_type"></div>';
                                }else if(parent.id==102020000){
                                    show_id = 0;/*重点手术 */
                                    var _combo='<div style="float: left;padding-right: 20px">' + show_combo[show_id].type + ':' + '</div><div style="float: left;line-height: 20px" class="show_type"></div>';
                                }else{
                                    var _combo='';
                                }

                                str = '<div class="row"><div style="color:seagreen" class = "col-xs-2  topic" >指标名称:</div><div class ="col-xs-10 no-padding"><div class ="col-xs-1 zb-name" style="width: auto">' + obj.text + '</div><div>'+_combo+'</div></div >';
                                $newAdd.append(str);
                                /*对应的重点疾病或重点手术下拉框加载*/
                                if(_combo!=''){
                                    $(".show_type").last().combobox({
                                        valueField: "id",
                                        textField: "text",
                                        multiple: true, /*多选 */
                                        multiline: true, /*多行显示选择的数据*/
                                        data: show_combo[show_id].combo,
                                        mode:"local",
                                        missingMessage:"必须填！",
                                        required:true,
                                        separator:" & ",
                                        onSelect:function () {
                                            var tr=  $(this).combobox("options");
                                            console.log(tr);
                                        },
                                        rules:{
                                            "customer":{
                                                message:"请输入存在的维度！",
                                                validator:function(q,_data){
                                                    var flag=false;
                                                    for (var i = 0,leg=_data.length; i <leg; i++) {
                                                        if(_data[i].text==q){
                                                            flag=true;
                                                            break;
                                                        }
                                                    }
                                                    return flag;
                                                }
                                            }
                                        },
                                        validType:"customer",
                                        validParams: show_combo[show_id].combo,
                                        validateOnBlur:true,
                                        onValidate:function (df) {
                                            console.log(df);
                                        },
                                        editable: true,
                                        width: 280,
                                        height: 30,
                                        lineHeight: 20,
                                        panelWidth: 280,
                                        panelHeight:"auto",
                                        panelMaxHeight: 300,
                                        onLoadSuccess: function () {
                                            $(this).siblings("span").find("textarea")[0].placeholder = "请选择(可以多选！)";
                                        },
                                        formatter: function (row) {
                                            return "<span class='glyphicon glyphicon-check' >&nbsp;" + row.text + "</span>"
                                        },
                                        /* filter: function (q,row){
                                         return true;
                                         console.log(q,row);
                                         }*/
                                    });
                                }

                            }
                        }
                        $zb.show();
                        $upload.hide();
                    } else {/*没有选择节点*/
                        alert("没有选择文件！");
                        return;
                    }
                } else {/*  上传数据（单选）*/
                    if (!nodes || nodes.children) {/* 没有选择节点，或选择的是目录 */
                        alert("请选择文件！");
                        return;
                    } else {
                        $zb.hide();
                        $upload.show();
                        htm = "<span >" + nodes.text + "</span>";
                        $(".update-name").html(htm);
                    }
                }
                $table.show();
                break;
            default:
                break;
        }
        $sourceSelected.window("close");
    });
    /* 是否合并表格 */
    $("input[name='rowspan']").click(function () {
        if ($(this).val() == 1) {
            $(".tab-merge").show();
        } else {
            $(".tab-merge").hide();
        }
    });
</script>
<script>
    /*tables加载*/
    $("#preChat").click(function () {
        $("#save").show();
        switch (is_zb) {
            case false:/*上传数据 这里我只做了两个表格，是写死的，点击预览获取的是html代码。 */
                var tabId=$("#sourceTree").tree("getSelected").id;/* 选择的节点id */
                if(tabId==12){
                    $.ajax({
                        url:"../../resources/ajax/tab12.json",
                        success:function (data) {
                            $(".pre").html(data.tab);
                            var val = $("input[name='rowspan']:checked").val();
                            if (val == 1) {
                                $(".rowspan").show();
                                $(".norowspan").hide();
                            } else {
                                $(".rowspan").hide();
                                $(".norowspan").show();
                            }
                        }
                    });
                }else{
                    $.ajax({
                        url:"../../resources/ajax/tab11.json",
                        success:function (data) {
                            $(".pre").html(data.tab);
                        }
                    });
                }
                break;
            default:/* 指标数据，该表分为左右表，左表显示指标名称和维度值，右表显示对应的时间下的值 */
                var comboData = $(".zb .textbox-text");/* 指标指标数据里的所以下拉框 */
                var tableArr = [], rightTabH ="";
                var leg = comboData.length;
                for (var i = 0; i < leg; i++) {
                    var obj = comboData[i];
                    tableArr.push(obj.value);
                }/*将 下拉框的的值变成数组*/
                var time = tableArr.slice(1, 5);
                /*获取选择的时间用来计算*/
                for (var i = 0; i < time.length; i++) {
                    time[i] = parseInt(time[i]);
                }
                var zbName = $(".newAdd").find(".zb-name");/*获取选择的指标*/
                var vueArr={},zbArr=[],rowNum=0;
                for (var i = 0; i < zbName.length; i++) {
                    var node=$(zbName[i]).parent().find(".textbox-text");
                    var obj=[];
                    if(node.length!=0){
                        if(node)
                            obj = node[0].value.split(",");/* 获取每一个下拉框的值，并且变为数组 */
                        console.log(obj,node[0].value);
                    }else{
                        obj=[""];
                    }
                    rowNum=rowNum+obj.length;
                    vueArr[i]= obj;/* 指标对应的维度数组 */
                    zbArr.push(zbName[i].innerHTML);/* 指标名称数组 */
                }
                console.log(vueArr,zbArr,rowNum);
                /*计算时间间隔，拼接右表头*/
                var _year = time[0], _month = time[1] - 1, _season = time[1] - 1;
                switch (tableArr[0]) {
                    case "年份":
                        colNum = time[2] - time[0];
                        _year=_year-1;
                        for (var i = 0; i < colNum + 1; i++) {
                            _year = _year + 1;
                            rightTabH += "<th width='100'>" + _year + "年" + "</th>";
                            console.log(colNum, _year);
                        }
                        break;
                    case "季度":
                        colNum = time[3] + (time[2] - time[0] - 1) * 4 + 4 - time[1];
                        for (var i = 0; i < colNum + 1; i++) {
                            if ((1 + _season) % 5 == 0) {
                                _season = 1;
                                _year++;
                            } else {
                                _season = (1 + _season) % 5;
                            }
                            rightTabH += "<th width='100'>" + _year + "年" + _season + "季度" + "</th>";
                            console.log(colNum, _year, _season);
                        }
                        break;
                    default:
                        colNum = time[3] + (time[2] - time[0] - 1) * 12 + 12 - time[1];
                        for (var i = 0; i < colNum + 1; i++) {
                            if ((1 + _month) % 13 == 0) {
                                _month = 1;
                                _year++;
                            } else {
                                _month = (1 + _month) % 13;
                            }
                            console.log(colNum, _year, _month);
                            rightTabH += "<th width='100'>" + _year + "年" + _month + "月" + "</th>";
                        }
                        break;
                }
                //右表身体
                var rightTabB = "";
                for (var i = 0; i < rowNum; i++) {
                    var _td="";
                    for (var j = 0; j < colNum+1; j++) {
                        _td+="<td >"+parseInt(Math.random()*50+5)+"</td>"
                    }
                    rightTabB+="<tr>"+_td+"</tr>";
                }
                //右表
                rightTabH = "<thead><tr>" + rightTabH + "</tr></thead>";
                var rightTab="<div class='col-xs-5 no-padding' style='overflow-x: auto'><table class='list1' width='100%' border='1' cellpadding='0' cellspacing='0' style='table-layout:fixed'>"+rightTabH+"<tbody>"+rightTabB+"</tbody></table></div>";

                //左表头
                var LeftTabH = '<thead><tr><th >科室</th> <th colspan="2" width="90%">指标</th></tr></thead>';
                var LeftTabB ="";
                var zbLeg = zbArr.length;

                //左表身体
                LeftTabB="<tr><td rowspan='" + rowNum + "'>" + tableArr[5] + "</td><td colspan='"+(vueArr[0][0]==""?2:1)+"' rowspan='"+vueArr[0].length+"'><div>" + zbArr[0] + "</div></td><td class='"+(vueArr[0][0]==""?"hide":"show")+"'><div>" +vueArr[0][0] + "</div></td></tr>";/*第一行*/
                for (var i = 0; i < zbLeg; i++) {
                    if(i==0){
                        if(vueArr[i][0]!="") {
                            for (var j = 1; j < vueArr[i].length; j++) {
                                LeftTabB += "<tr><td><div>" + vueArr[i][j] + "</div></td></tr>"
                            }
                        }
                    }else{
                        LeftTabB+="<tr><td colspan='"+(vueArr[i][0]==""?2:1)+"'  rowspan='"+vueArr[i].length+"'><div>"+zbArr[i]+"</div></td><td class='"+(vueArr[i][0]==""?"hide":"show")+"'><div>"+vueArr[i][0]+"</div></td></tr>";
                        if(vueArr[i][0]!="") {
                            for (var j = 1; j < vueArr[i].length; j++) {
                                LeftTabB += "<tr><td><div>" + vueArr[i][j] + "</div></td></tr>"
                            }
                        }
                    }
                }
                /* 左表 */
                var LetTab = "<div class='col-xs-7 no-padding'><table class='list1' style='width: 100%;table-layout: fixed'>" + LeftTabH + "<tbody>" + LeftTabB + "</tbody>" + "</table></div>";
                /*左右表合并  */
                $(".pre").html(LetTab+rightTab);
                break;
        }
        $(".pre").show();



    });
    
</script>
</body>
</html>
